WITH cast_date AS
(
SELECT 
	TIMESTAMP
	, CAST(TIMESTAMP AS DATE) AS LOAD_DATE
	, CAST(TIMESTAMP AS TIME) AS LOAD_TIME
	, GPSNORTHING
	, GPSEASTING
	, GPSELEVATION
	, FUEL_RATE
	, STATUS
	, PAYLOAD
	, TRUCK_ID
	, TRUCK_TYPE_ID
	, SHOVEL_ID
	, DUMP_ID
	, RND
  FROM [Teck].[dbo].[df]
)

,avg_fuel_date AS
(SELECT
	AVG(FUEL_RATE) AS AVG_FUEL_RATE_DATE
	, LOAD_DATE
FROM cast_date
WHERE FUEL_RATE <> 0 AND FUEL_RATE IS NOT NULL
GROUP BY LOAD_DATE
)

,avg_fuel_truck_date AS
(SELECT
	AVG(FUEL_RATE) AS AVG_FUEL_RATE_TRUCK_DATE
	, TRUCK_ID
	, LOAD_DATE
FROM cast_date
WHERE FUEL_RATE <> 0 AND FUEL_RATE IS NOT NULL
GROUP BY TRUCK_ID, LOAD_DATE
)

,avg_fuel_truck AS
(SELECT
	AVG(FUEL_RATE) AS AVG_FUEL_TRUCK
	, TRUCK_ID
FROM cast_date
WHERE FUEL_RATE <> 0 AND FUEL_RATE IS NOT NULL
GROUP BY TRUCK_ID
)


SELECT
	 c.TRUCK_ID
	, c.LOAD_DATE
	, AVG_FUEL_TRUCK AS AVG_FUEL_OF_SPECIFIC_TRUCK_ON_ALL_DATES
	, f.AVG_FUEL_RATE_DATE AS AVG_FUEL_OF_ALL_TRUCKS_ON_SPECIFIC_DATE
	, AVG_FUEL_RATE_TRUCK_DATE AS AVG_FUEL_OF_SPECIFIC_TRUCK_ON_DATE
FROM avg_fuel_truck_date c
	INNER JOIN avg_fuel_date f ON c.LOAD_DATE = f.LOAD_DATE
	INNER JOIN avg_fuel_truck t ON c.TRUCK_ID = t.TRUCK_ID
ORDER BY LOAD_DATE, TRUCK_ID
	